
> eventia-backend@1.0.0 test
> jest --coverage src/__tests__/integration/eventRoutes.test.ts

  console.log
    Loading environment from .env.test

      at Object.<anonymous> (src/config/index.ts:18:11)

2025-11-23 02:14:12 [32minfo[39m: Registered route: /upi-settings
2025-11-23 02:14:12 [32minfo[39m: Registered route: /events
2025-11-23 02:14:12 [32minfo[39m: Registered route: /users
2025-11-23 02:14:12 [32minfo[39m: Registered route: /upi
2025-11-23 02:14:12 [32minfo[39m: Registered route: /auth
2025-11-23 02:14:12 [32minfo[39m: Registered route: /users
2025-11-23 02:14:12 [32minfo[39m: Registered route: /events
2025-11-23 02:14:12 [32minfo[39m: Registered route: /bookings
2025-11-23 02:14:12 [32minfo[39m: Registered route: /payments
2025-11-23 02:14:12 [32minfo[39m: Registered route: /discounts
2025-11-23 02:14:12 [32minfo[39m: Registered route: /seats
2025-11-23 02:14:12 [32minfo[39m: Registered route: /seat-locks
2025-11-23 02:14:12 [32minfo[39m: Registered route: /ticket-categories
2025-11-23 02:14:12 [32minfo[39m: Registered route: /tickets
2025-11-23 02:14:12 [32minfo[39m: Registered route: /payment-initialize
2025-11-23 02:14:12 [32minfo[39m: Registered route: /verify-utr
2025-11-23 02:14:12 [32minfo[39m: Registered route: /health
2025-11-23 02:14:12 [32minfo[39m: Registered route: /state-sync
2025-11-23 02:14:12 [32minfo[39m: DataLoader middleware initialized for optimized queries
2025-11-23 02:14:12 [32minfo[39m: WebSocket server initialized
2025-11-23 02:14:12 [32minfo[39m: WebSocket service initialized
2025-11-23 02:14:12 [32minfo[39m: Background jobs initialized
2025-11-23 02:14:12 [32minfo[39m: Request Headers:
2025-11-23 02:14:12 [32minfo[39m: After BodyParser (Top) - req.body:
2025-11-23 02:14:12 [32minfo[39m: Validate Middleware - req.body:
2025-11-23 02:14:12 [32minfo[39m: Validate Middleware - sanitizedData.body:
2025-11-23 02:14:12 [32minfo[39m: prisma:query
2025-11-23 02:14:12 [32minfo[39m: prisma:query
2025-11-23 02:14:12 [32mhttp[39m: [0mGET /api/v1/events [32m200[0m 24.243 ms - 604[0m
2025-11-23 02:14:12 [32minfo[39m: GET /events response body:
2025-11-23 02:14:12 [32minfo[39m: Request Headers:
2025-11-23 02:14:12 [32minfo[39m: After BodyParser (Top) - req.body:
2025-11-23 02:14:12 [32minfo[39m: Validate Middleware - req.body:
2025-11-23 02:14:12 [32minfo[39m: Validate Middleware - sanitizedData.body:
2025-11-23 02:14:12 [32minfo[39m: prisma:query
2025-11-23 02:14:12 [32minfo[39m: prisma:query
2025-11-23 02:14:12 [32mhttp[39m: [0mGET /api/v1/events [32m200[0m 7.040 ms - 604[0m
2025-11-23 02:14:13 [32minfo[39m: Request Headers:
2025-11-23 02:14:13 [32minfo[39m: After BodyParser (Top) - req.body:
2025-11-23 02:14:13 [32minfo[39m: Validate Middleware - req.body:
2025-11-23 02:14:13 [32minfo[39m: Validate Middleware - sanitizedData.body:
2025-11-23 02:14:13 [31merror[39m: [POST] /api/v1/events - Validation failed
2025-11-23 02:14:13 [32mhttp[39m: [0mPOST /api/v1/events [33m400[0m 12.370 ms - 300[0m
2025-11-23 02:14:13 [32minfo[39m: POST /events failed: {
  "success": false,
  "error": {
    "code": "VALIDATION_ERROR",
    "message": "Validation failed",
    "details": [
      {
        "path": "title",
        "message": "Required",
        "code": "invalid_type"
      },
      {
        "path": "location",
        "message": "Required",
        "code": "invalid_type"
      },
      {
        "path": "startDate",
        "message": "Invalid input",
        "code": "invalid_union"
      }
    ]
  },
  "data": null
}
2025-11-23 02:14:13 [32minfo[39m: Request Headers:
2025-11-23 02:14:13 [32minfo[39m: After BodyParser (Top) - req.body:
2025-11-23 02:14:13 [34mdebug[39m: Authentication failed: No token provided
2025-11-23 02:14:13 [31merror[39m: [POST] /api/v1/events - Authentication required
2025-11-23 02:14:13 [32mhttp[39m: [0mPOST /api/v1/events [33m401[0m 10.918 ms - 102[0m
----------------------------------------------------|---------|----------|---------|---------|----------------------------------------------------------------------------------------------------------------
File                                                | % Stmts | % Branch | % Funcs | % Lines | Uncovered Line #s                                                                                              
----------------------------------------------------|---------|----------|---------|---------|----------------------------------------------------------------------------------------------------------------
All files                                           |    21.4 |     5.78 |    7.28 |   21.08 |                                                                                                                
 src                                                |   87.69 |    35.71 |      75 |    87.3 |                                                                                                                
  app.ts                                            |   87.69 |    35.71 |      75 |    87.3 | 88-91,104-107,129,139                                                                                          
 src/controllers                                    |   12.61 |        0 |       0 |    12.5 |                                                                                                                
  authController.ts                                 |   18.57 |        0 |       0 |   18.57 | 15-38,45-94,106-171,186-190,199-213                                                                            
  booking.controller.ts                             |   15.21 |        0 |       0 |   15.38 | 21-107,114-135,142-193,200-222,229-325                                                                         
  dashboard.controller.ts                           |       0 |        0 |       0 |       0 | 2-125                                                                                                          
  discount.controller.ts                            |   16.66 |        0 |       0 |   16.86 | 16-20,29-41,50-60,69-97,106-111,120-125,134-158,167-194,203-218                                                
  event.controller.ts                               |   16.06 |        0 |       0 |   17.31 | 28-34,50-69,78-104,112-140,148-168,177-196,212-218,227-289,300-355,367-414,423-439,447-504,518-620             
  metricsController.ts                              |    6.97 |        0 |       0 |    6.97 | 14-164                                                                                                         
  payment.controller.ts                             |   12.95 |        0 |       0 |    12.7 | 30-107,116-141,150-180,189-201,209-226,234-304,313-419,428-488,497-557,571-615,624-647,657-719,727-728,736-802 
  public.controller.ts                              |   24.24 |        0 |       0 |   24.24 | 16-37,45-105                                                                                                   
  reservationController.ts                          |   18.68 |        0 |       0 |   14.45 | 14,19-45,50-68,77,81-118,126-161,169-198                                                                       
  seat.controller.ts                                |    9.25 |        0 |       0 |    9.25 | 21-361                                                                                                         
  seatLocking.controller.ts                         |       0 |        0 |       0 |       0 | 2-234                                                                                                          
  stateSync.controller.ts                           |   13.79 |        0 |       0 |   13.79 | 16-97                                                                                                          
  stripe.controller.ts                              |   10.14 |        0 |       0 |   10.14 | 16-206                                                                                                         
  ticket.controller.ts                              |    6.14 |        0 |       0 |    6.14 | 20-338                                                                                                         
  ticketCategory.controller.ts                      |   26.53 |        0 |       0 |   26.53 | 13-35,42-48,55-65,72-94,101-116,123-146                                                                        
  upiPayment.controller.ts                          |       0 |        0 |       0 |       0 | 1-434                                                                                                          
  upiSettings.controller.ts                         |   26.47 |        0 |       0 |   26.47 | 11-15,25-42,52-74,84-112,122-128                                                                               
  user.controller.ts                                |   22.91 |        0 |       0 |   22.91 | 12-36,50-68,75-101,108-118,125-147,154-177                                                                     
 src/controllers/admin                              |    8.45 |        0 |       0 |    8.94 |                                                                                                                
  event.controller.ts                               |       0 |        0 |       0 |       0 | 2-255                                                                                                          
  upiSettings.controller.ts                         |    12.5 |        0 |       0 |   12.97 | 37-50,58-85,95-156,167-255,268-323,332-386                                                                     
 src/controllers/v1                                 |   21.68 |     7.79 |    7.69 |   21.68 |                                                                                                                
  event.controller.ts                               |   30.37 |       15 |   16.66 |   30.37 | 44-45,53,58,89-112,120-165,182-214,221-263,275-294,306-332                                                     
  user.controller.ts                                |   13.79 |        0 |       0 |   13.79 | 18-47,54-150,157-184,192-240,248-273,281-326,334-354                                                           
 src/db                                             |    24.2 |    11.76 |    4.54 |   21.85 |                                                                                                                
  index.ts                                          |   31.25 |     12.5 |       0 |   27.27 | 42-46,69-95,104-110,118-124                                                                                    
  prisma.ts                                         |    21.1 |    11.66 |    6.66 |   19.62 | 16-24,49,64-73,82-83,89-101,106-118,126-214,225-232,240-244                                                    
 src/db/migrations                                  |       0 |      100 |       0 |       0 |                                                                                                                
  20230501000001_initial_schema.ts                  |       0 |      100 |       0 |       0 | 4-168                                                                                                          
  20240426000004_payment_tables.ts                  |       0 |      100 |       0 |       0 | 4-36                                                                                                           
 src/examples                                       |       0 |        0 |       0 |       0 |                                                                                                                
  optimized-controller.example.ts                   |       0 |        0 |       0 |       0 | 2-160                                                                                                          
 src/middleware                                     |   36.97 |     19.6 |   33.96 |   34.65 |                                                                                                                
  auth.ts                                           |   55.68 |    42.85 |   54.54 |   53.08 | 48,56,60-61,79-80,87-100,110,121-122,128-134,147-164,179-189                                                   
  cache.ts                                          |   18.75 |        0 |      25 |   15.21 | 25-112,122-127                                                                                                 
  csrf.ts                                           |   28.94 |        0 |       0 |      25 | 22-40,48-87                                                                                                    
  database.ts                                       |      50 |      100 |       0 |   42.85 | 20-25                                                                                                          
  dataloader.middleware.ts                          |     100 |      100 |     100 |     100 |                                                                                                                
  errorBoundary.ts                                  |       0 |        0 |       0 |       0 | 2-132                                                                                                          
  errorHandler.ts                                   |    40.9 |    29.41 |     100 |   38.09 | 39-111                                                                                                         
  index.ts                                          |       0 |        0 |       0 |       0 | 2-47                                                                                                           
  rateLimit.ts                                      |       0 |        0 |       0 |       0 | 1-130                                                                                                          
  upload.ts                                         |   52.63 |        0 |   28.57 |   51.35 | 13,19,29-36,43-54,91-106                                                                                       
  validate.ts                                       |   68.25 |    41.66 |      60 |   69.09 | 28-29,51,62-71,94-99,113,123-127,135-136                                                                       
 src/migrations                                     |       0 |      100 |       0 |       0 |                                                                                                                
  20240615000000_create_bookings.ts                 |       0 |      100 |       0 |       0 | 3-16                                                                                                           
  20240615000001_create_booking_payments.ts         |       0 |      100 |       0 |       0 | 3-17                                                                                                           
  20240625000000_create_reservation_expiry_queue.ts |       0 |      100 |       0 |       0 | 6-25                                                                                                           
  20240626000000_create_ticket_generation_queue.ts  |       0 |      100 |       0 |       0 | 6-28                                                                                                           
 src/models                                         |   28.26 |    10.81 |    5.55 |   29.32 |                                                                                                                
  booking.ts                                        |       0 |        0 |       0 |       0 | 2-196                                                                                                          
  index.ts                                          |       0 |      100 |     100 |       0 | 3-9                                                                                                            
  payment.ts                                        |   17.64 |        0 |       0 |   18.18 | 55-161,173-235                                                                                                 
  seat.ts                                           |   31.57 |       20 |      10 |   31.57 | 83-235                                                                                                         
  seatLock.ts                                       |     100 |      100 |     100 |     100 |                                                                                                                
  user.ts                                           |   61.11 |        0 |       0 |   61.11 | 41-68                                                                                                          
 src/repositories                                   |   17.79 |    16.81 |   17.24 |   18.34 |                                                                                                                
  discountRepository.ts                             |       0 |        0 |       0 |       0 | 2-314                                                                                                          
  event.repository.ts                               |   30.88 |    28.35 |   41.66 |    32.3 | 57,68-70,93,113-271,286-293,304,316-320,328,332-333,343,352,357,384-396                                        
  userRepository.ts                                 |       0 |        0 |       0 |       0 | 1-123                                                                                                          
 src/routes                                         |   68.22 |        0 |       0 |   68.42 |                                                                                                                
  admin.routes.ts                                   |       0 |      100 |       0 |       0 | 1-266                                                                                                          
  auth.ts                                           |     100 |      100 |     100 |     100 |                                                                                                                
  booking.routes.ts                                 |     100 |      100 |     100 |     100 |                                                                                                                
  discount.routes.ts                                |     100 |      100 |     100 |     100 |                                                                                                                
  event.routes.ts                                   |   86.36 |        0 |       0 |   86.36 | 188-191                                                                                                        
  events.routes.ts                                  |       0 |      100 |     100 |       0 | 1-12                                                                                                           
  health.routes.ts                                  |    25.8 |        0 |       0 |   26.66 | 83-130,158-178                                                                                                 
  healthRoutes.ts                                   |       0 |      100 |       0 |       0 | 1-7                                                                                                            
  index.ts                                          |   93.75 |      100 |       0 |   93.75 | 22,32                                                                                                          
  metricsRoutes.ts                                  |     100 |      100 |     100 |     100 |                                                                                                                
  payment.initialize.routes.ts                      |     100 |      100 |     100 |     100 |                                                                                                                
  payment.routes.ts                                 |     100 |      100 |     100 |     100 |                                                                                                                
  reservation.routes.ts                             |      60 |      100 |       0 |      60 | 13-18,24                                                                                                       
  reservationRoutes.ts                              |       0 |      100 |     100 |       0 | 1-23                                                                                                           
  seat.lock.routes.ts                               |     100 |      100 |     100 |     100 |                                                                                                                
  seat.routes.ts                                    |     100 |      100 |     100 |     100 |                                                                                                                
  stateSync.routes.ts                               |     100 |      100 |     100 |     100 |                                                                                                                
  stripe.routes.ts                                  |     100 |      100 |     100 |     100 |                                                                                                                
  ticket.routes.ts                                  |   65.51 |      100 |       0 |   65.51 | 115,142,171,209,257,293,332,359,387,415                                                                        
  ticketCategory.routes.ts                          |     100 |      100 |     100 |     100 |                                                                                                                
  upiSettings.routes.ts                             |     100 |      100 |     100 |     100 |                                                                                                                
  utrVerification.routes.ts                         |   61.11 |        0 |       0 |   61.11 | 18-51,57                                                                                                       
 src/routes/admin                                   |       0 |      100 |     100 |       0 |                                                                                                                
  events.routes.ts                                  |       0 |      100 |     100 |       0 | 1-28                                                                                                           
 src/routes/v1                                      |   68.57 |      100 |       0 |   68.57 |                                                                                                                
  auth.routes.ts                                    |   72.72 |      100 |       0 |   72.72 | 19,28,35,42,88,95                                                                                              
  dynamicPricing.route.ts                           |       0 |      100 |     100 |       0 | 1-62                                                                                                           
  event.routes.ts                                   |   58.62 |      100 |       0 |   58.62 | 157-171,185-224                                                                                                
  index.ts                                          |     100 |      100 |     100 |     100 |                                                                                                                
  public.routes.ts                                  |       0 |      100 |     100 |       0 | 11-14                                                                                                          
  user.routes.ts                                    |     100 |      100 |     100 |     100 |                                                                                                                
 src/routes/v1/admin                                |   63.15 |        0 |       0 |   63.15 |                                                                                                                
  event.routes.ts                                   |     100 |      100 |     100 |     100 |                                                                                                                
  index.ts                                          |      75 |        0 |       0 |      75 | 25-27,32-33                                                                                                    
  template.routes.ts                                |       0 |      100 |       0 |       0 | 1-72                                                                                                           
  upiSettings.routes.ts                             |   93.33 |      100 |       0 |   93.33 | 31                                                                                                             
  user.routes.ts                                    |      80 |      100 |       0 |      80 | 63,75,88,100                                                                                                   
 src/routes/v1/public                               |   46.42 |        0 |       0 |   46.42 |                                                                                                                
  index.ts                                          |     100 |      100 |     100 |     100 |                                                                                                                
  template.routes.ts                                |       0 |        0 |       0 |       0 | 1-57                                                                                                           
  upi.routes.ts                                     |     100 |      100 |     100 |     100 |                                                                                                                
 src/scripts                                        |       0 |        0 |       0 |       0 |                                                                                                                
  add-ipl-events.ts                                 |       0 |        0 |       0 |       0 | 1-226                                                                                                          
  create-test-user.ts                               |       0 |      100 |       0 |       0 | 1-32                                                                                                           
  fix-ticket-generation-queue.ts                    |       0 |      100 |       0 |       0 | 12-24                                                                                                          
  release-expired-payment-sessions.ts               |       0 |        0 |       0 |       0 | 8-36                                                                                                           
  run-migration.ts                                  |       0 |      100 |       0 |       0 | 8-26                                                                                                           
  seed-events.ts                                    |       0 |        0 |       0 |       0 | 8-208                                                                                                          
  seed-upi-settings.ts                              |       0 |        0 |       0 |       0 | 8-72                                                                                                           
  test-user-profile-api.ts                          |       0 |      100 |       0 |       0 | 7-59                                                                                                           
  test-user-profile.ts                              |       0 |      100 |       0 |       0 | 7-76                                                                                                           
 src/services                                       |    7.31 |     0.75 |    3.22 |    7.15 |                                                                                                                
  authService.ts                                    |       0 |        0 |       0 |       0 | 1-118                                                                                                          
  booking.service.ts                                |   12.69 |        0 |       0 |    9.83 | 38-215,281-294,305-344                                                                                         
  cacheService.ts                                   |       0 |        0 |       0 |       0 | 1-137                                                                                                          
  discount.service.ts                               |    3.09 |        0 |       0 |     3.4 | 10-280                                                                                                         
  dynamicPricing.service.ts                         |       0 |        0 |       0 |       0 | 1-306                                                                                                          
  event.service.ts                                  |   10.65 |        0 |    7.14 |   10.92 | 36,48-475                                                                                                      
  index.ts                                          |       0 |      100 |     100 |       0 | 3-9                                                                                                            
  job.service.ts                                    |       0 |        0 |       0 |       0 | 1-159                                                                                                          
  payment.service.ts                                |    14.7 |        0 |       0 |    14.7 | 19-151                                                                                                         
  reservation.service.ts                            |   10.52 |        0 |       0 |   11.42 | 15-142                                                                                                         
  seat.service.ts                                   |    3.57 |        0 |       0 |    3.65 | 31-716                                                                                                         
  stateSync.service.ts                              |    6.52 |        0 |       0 |    6.74 | 24-315                                                                                                         
  stripe.service.ts                                 |    9.67 |    14.28 |       0 |    9.67 | 20-108                                                                                                         
  team.service.ts                                   |       0 |      100 |       0 |       0 | 2-49                                                                                                           
  ticket.service.ts                                 |     4.8 |        0 |       0 |    4.87 | 22-733                                                                                                         
  transaction.service.ts                            |   22.22 |     5.88 |   28.57 |   23.07 | 50-176                                                                                                         
  upiPayment.service.ts                             |   41.66 |        0 |       0 |      30 | 14-28,39,49-68,80-83                                                                                           
  websocket.service.ts                              |    12.3 |        0 |      10 |   13.91 | 35,46-384,399                                                                                                  
 src/services/api                                   |       0 |        0 |       0 |       0 |                                                                                                                
  apiUtils.ts                                       |       0 |        0 |       0 |       0 | 1-23                                                                                                           
  paymentApi.ts                                     |       0 |      100 |       0 |       0 | 1-69                                                                                                           
 src/utils                                          |   28.47 |    12.72 |   23.68 |   26.68 |                                                                                                                
  apiError.ts                                       |   66.66 |     7.69 |    37.5 |   66.66 | 53-81                                                                                                          
  apiResponse.ts                                    |      30 |    26.66 |   16.66 |      30 | 37-38,66-128                                                                                                   
  asyncHandler.ts                                   |      75 |        0 |     100 |   71.42 | 42-50                                                                                                          
  catchAsync.ts                                     |      75 |      100 |      50 |   66.66 | 5                                                                                                              
  dataloader.ts                                     |   24.39 |        0 |   26.66 |   25.64 | 25-46,60-115                                                                                                   
  date-utils.ts                                     |   36.36 |        0 |       0 |   23.52 | 7-8,21-22,37-39,48-56                                                                                          
  errorCodes.ts                                     |     100 |      100 |     100 |     100 |                                                                                                                
  fileUpload.ts                                     |       0 |        0 |       0 |       0 | 1-146                                                                                                          
  fix-queries.ts                                    |       0 |      100 |       0 |       0 | 1-63                                                                                                           
  fix-ticket-generation-queue.ts                    |       0 |        0 |       0 |       0 | 6-96                                                                                                           
  generateRouteDocs.ts                              |       0 |        0 |       0 |       0 | 1-37                                                                                                           
  index.ts                                          |     100 |      100 |     100 |     100 |                                                                                                                
  jwt.ts                                            |    42.1 |     12.5 |      50 |   37.14 | 16-17,47-80,90-93                                                                                              
  logger.ts                                         |   62.96 |       50 |   28.57 |   62.96 | 8,58,70-71,75-76,80-81,85-86                                                                                   
  pdf-generator.ts                                  |   10.41 |        0 |       0 |    6.52 | 12-73,81-82                                                                                                    
  qrCode.ts                                         |       0 |      100 |       0 |       0 | 1-23                                                                                                           
  retry.ts                                          |   13.04 |        0 |       0 |   13.63 | 36-83                                                                                                          
  routeHelper.ts                                    |   23.91 |     12.5 |   18.18 |    18.6 | 24-56,65-96                                                                                                    
 src/validations                                    |   52.17 |        0 |       0 |      50 |                                                                                                                
  booking.validation.ts                             |     100 |      100 |     100 |     100 |                                                                                                                
  custom.validation.ts                              |      50 |      100 |       0 |   33.33 | 11,20,29-33,43-44,54-55                                                                                        
  discount.validation.ts                            |     100 |      100 |     100 |     100 |                                                                                                                
  dynamicPricing.validation.ts                      |       0 |        0 |       0 |       0 | 1-78                                                                                                           
  event.validation.ts                               |      75 |        0 |       0 |   72.72 | 59-66                                                                                                          
  payment.validation.ts                             |   93.33 |      100 |       0 |   93.33 | 9                                                                                                              
  payment.validations.ts                            |       0 |      100 |     100 |       0 | 1-94                                                                                                           
  seat.validation.ts                                |   88.88 |      100 |       0 |   88.88 | 34                                                                                                             
  seatLocking.validation.ts                         |       0 |      100 |     100 |       0 | 1-44                                                                                                           
  ticket.validation.ts                              |     100 |      100 |     100 |     100 |                                                                                                                
  ticketCategory.validation.ts                      |   64.28 |      100 |       0 |   64.28 | 11,17,30,39,45                                                                                                 
  upiPayment.validations.ts                         |       0 |      100 |     100 |       0 | 1-66                                                                                                           
  user.validation.ts                                |       0 |      100 |     100 |       0 | 1-30                                                                                                           
 src/validators                                     |   25.92 |        0 |       0 |   26.92 |                                                                                                                
  booking.validator.ts                              |       0 |      100 |     100 |       0 | 1-24                                                                                                           
  dynamicPricing.validator.ts                       |       0 |      100 |     100 |       0 | 1-20                                                                                                           
  event.validator.ts                                |      50 |        0 |       0 |   53.84 | 28-31,50-53                                                                                                    
  ticketCategory.validator.ts                       |       0 |      100 |     100 |       0 | 1-18                                                                                                           
----------------------------------------------------|---------|----------|---------|---------|----------------------------------------------------------------------------------------------------------------
